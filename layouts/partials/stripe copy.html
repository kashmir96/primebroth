<script src="https://js.stripe.com/v3/"></script>

<script>
    document.querySelectorAll('input[name="productSize"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            document.getElementById('productsmall').classList.toggle('hidden', this.value !== 'small');
            document.getElementById('productmedium').classList.toggle('hidden', this.value !== 'medium');
            document.getElementById('productlarge').classList.toggle('hidden', this.value !== 'large');
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const radioLabels = document.querySelectorAll('.radio-label');
        const mainImage = document.querySelector('.main-image');

        radioLabels.forEach(label => {
            const input = label.querySelector('input');
            const radioText = label.querySelector('.radio-text');

            // Apply initial state based on checked attribute
            if (input.checked) {
                label.classList.add('checked');
                mainImage.src = input.getAttribute('data-image');
            }

            // Add event listener to update state on change
            input.addEventListener('change', function () {
                if (input.checked) {
                    radioLabels.forEach(l => l.classList.remove('checked'));
                    label.classList.add('checked');
                    mainImage.src = input.getAttribute('data-image');
                }
            });
        });

        const stripe = Stripe('pk_live_51Ot2iTABkrUo6tgOu44jd79tB4Dg2B64I6lucmLcKdxZfcy2Dy3bTnbxQNiwDtRfeWSwWx1WsDpC0h91tTlubPXW000IuWtQTX'); // Replace with your actual publishable key

        function createCheckoutSession(priceId, quantity) {
            return fetch('/.netlify/functions/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    priceId: priceId,
                    quantity: quantity
                })
            }).then(function (response) {
                return response.json();
            }).catch(function (error) {
                console.error('Error fetching checkout session:', error);
                throw error;
            });
        }

        function handleCheckout(priceId, quantity) {
            createCheckoutSession(priceId, quantity).then(function (data) {
                if (data.sessionId) {
                    return stripe.redirectToCheckout({ sessionId: data.sessionId });
                } else {
                    console.error('No sessionId returned:', data);
                    alert('Failed to create checkout session. Please try again.');
                }
            }).catch(function (error) {
                console.error('Error creating checkout session:', error);
                alert('Failed to create checkout session. Please try again.');
            });
        }

        document.querySelectorAll('.buy-now').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const priceId = button.getAttribute('data-price-id');
                const quantityId = button.getAttribute('data-quantity-id');
                const quantity = document.getElementById(quantityId).value;
                handleCheckout(priceId, quantity);
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const pgurl = '{{ .Params.pgurl }}';
        const charity = '{{ .Params.charity }}';
        localStorage.setItem('pgurl', pgurl);
        localStorage.setItem('charity', charity);
        console.log('pgurl stored:', pgurl);  // Debugging line
        console.log('charity stored:', charity);  // Debugging line

        // Update flavor text and price IDs based on dropdown selection
        document.getElementById('productFlavour').addEventListener('change', function() {
            var flavour = this.value;
            var selectedOption = this.options[this.selectedIndex];
            var priceSmall = selectedOption.getAttribute('data-flavour-price-small');
            var priceMedium = selectedOption.getAttribute('data-flavour-price-medium');
            var priceLarge = selectedOption.getAttribute('data-flavour-price-large');
            
            document.querySelectorAll('.product-flavour').forEach(function(span) {
                span.textContent = flavour.charAt(0).toUpperCase() + flavour.slice(1);
            });

            document.querySelector('#productsmall .buy-now').setAttribute('data-price-id', priceSmall);
            document.querySelector('#productmedium .buy-now').setAttribute('data-price-id', priceMedium);
            document.querySelector('#productlarge .buy-now').setAttribute('data-price-id', priceLarge);
        });
    });

    document.querySelectorAll('.image-container img').forEach(function(image) {
        image.addEventListener('click', function() {
            // Hide the image container
            this.parentElement.style.display = 'none';
            // Show the corresponding video container
            var videoId = this.getAttribute('data-video-id');
            document.getElementById(videoId).style.display = 'block';
        });
    });
</script>
